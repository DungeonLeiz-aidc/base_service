# ğŸ—ï¸ Alembic - Há»‡ thá»‘ng Quáº£n trá»‹ PhiÃªn báº£n DB / Advanced Database Migration Tooling

**Má»¥c Ä‘Ã­ch / Purpose**: Alembic khÃ´ng chá»‰ lÃ  má»™t cÃ´ng cá»¥ cháº¡y lá»‡nh; nÃ³ lÃ  má»™t há»‡ sinh thÃ¡i giÃºp Ä‘á»“ng bá»™ hÃ³a tráº¡ng thÃ¡i giá»¯a mÃ£ nguá»“n (SQLAlchemy Models) vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u thá»±c táº¿. ThÆ° má»¥c nÃ y chá»©a toÃ n bá»™ cáº¥u hÃ¬nh Ä‘iá»u khiá»ƒn "Cá»— mÃ¡y thá»i gian" cá»§a dá»¯ liá»‡u. / Alembic is more than a CLI tool; it is an ecosystem that synchronizes state between source code (SQLAlchemy Models) and the live database. This directory contains the control configuration for the data "Time Machine".

Tiáº¿ng Viá»‡t | [English](#-english-version)

---

## ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t

### ğŸ“„ Bá»‘i cáº£nh & ThÃ nh pháº§n (Context & Components)
- **alembic.ini**: Táº­p tin cáº¥u hÃ¬nh gá»‘c (náº±m á»Ÿ thÆ° má»¥c gá»‘c dá»± Ã¡n). NÃ³ Ä‘á»‹nh nghÄ©a Ä‘Æ°á»ng dáº«n Ä‘áº¿n cÃ¡c script migration vÃ  cÃ¡c cÃ i Ä‘áº·t vá» logging.
- **env.py**: "TrÃ¡i tim" cá»§a quÃ¡ trÃ¬nh thá»±c thi. ÄÃ¢y lÃ  script Python náº¡p cáº¥u hÃ¬nh tá»« SQLAlchemy engine vÃ  metadata cá»§a Domain Ä‘á»ƒ so sÃ¡nh sá»± thay Ä‘á»•i.
- **script.py.mako**: "Báº£n thiáº¿t káº¿" (Template) cho cÃ¡c file migration má»›i.

### ğŸ’¡ Táº¡i sao cáº§n `script.py.mako`? (The Template Why)
- **TÃ­nh nháº¥t quÃ¡n**: Äáº£m báº£o má»i báº£n migration Ä‘á»u cÃ³ chung má»™t cáº¥u trÃºc chuáº©n (vÃ­ dá»¥: luÃ´n cÃ³ `upgrade()` vÃ  `downgrade()`).
- **Customization**: Cho phÃ©p chÃºng ta thÃªm sáºµn cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t (nhÆ° `import uuid` hay `custom_types`) vÃ o má»i file migration Ä‘Æ°á»£c sinh ra tá»± Ä‘á»™ng, giÃºp tiáº¿t kiá»‡m thá»i gian vÃ  trÃ¡nh lá»—i quÃªn import.

### âš ï¸ RÃ ng buá»™c & LÆ°u Ã½ (Constraints)
1. **Metadata Wiring**: Trong `env.py`, biáº¿n `target_metadata` pháº£i trá» Ä‘Ãºng vÃ o Metadata cá»§a cÃ¡c Models (`Base.metadata`) thÃ¬ tÃ­nh nÄƒng `--autogenerate` má»›i hoáº¡t Ä‘á»™ng.
2. **Template Safety**: KhÃ´ng nÃªn sá»­a cÃ¡c biáº¿n trong dáº¥u `${}` cá»§a file `.mako` trá»« khi báº¡n hiá»ƒu rÃµ cÃ¡ch Alembic truyá»n dá»¯ liá»‡u vÃ o template.

### ğŸ›ï¸ VÃ­ dá»¥ thá»±c táº¿ (Practical Examples)
- Náº¿u báº¡n muá»‘n má»i file migration Ä‘á»u tá»± Ä‘á»™ng cÃ³ lá»‡nh logging, báº¡n sáº½ sá»­a file `script.py.mako`.
- Xem cÃ¡ch quáº£n lÃ½ chuá»—i migration táº¡i: [alembic/versions/README.md](file:///home/korosaki-ryukai/Workspace/Service/base_service/alembic/versions/README.md)

---

## ğŸ‡ºğŸ‡¸ English Version

### ğŸ“„ Context & Components
- **alembic.ini**: The root configuration file (located in the project root). It defines paths to migration scripts and logging settings.
- **env.py**: The "Heart" of execution. This Python script loads configuration from the SQLAlchemy engine and Domain metadata to compare changes.
- **script.py.mako**: The "Blueprint" (Template) for generating new migration files.

### ğŸ’¡ Why `script.py.mako`?
- **Consistency**: Ensures every migration file follows a standardized structure (e.g., always including `upgrade()` and `downgrade()`).
- **Customization**: Allows pre-defining essential imports (like `uuid` or `custom_types`) for all autogenerated migrations, saving time and preventing manual import errors.

### âš ï¸ Constraints & Rationale
1. **Metadata Wiring**: In `env.py`, the `target_metadata` variable must point correctly to the Models' Metadata (`Base.metadata`) for `--autogenerate` to function.
2. **Template Safety**: Avoid modifying variables within `${}` in the `.mako` file unless you understand how Alembic injects data into the template.

### ğŸ›ï¸ Practical Examples
- To automatically include logging in every new migration file, modify `script.py.mako`.
- Learn about migration chain management: [alembic/versions/README.md](file:///home/korosaki-ryukai/Workspace/Service/base_service/alembic/versions/README.md)
