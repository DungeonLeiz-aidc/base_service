# ğŸ—ï¸ Alembic - Há»‡ thá»‘ng Quáº£n trá»‹ PhiÃªn báº£n DB / Advanced Database Migration Tooling

**Má»¥c Ä‘Ã­ch / Purpose**: Alembic giÃºp Ä‘á»“ng bá»™ hÃ³a tráº¡ng thÃ¡i giá»¯a mÃ£ nguá»“n (SQLAlchemy Models) vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u thá»±c táº¿ má»™t cÃ¡ch an toÃ n vÃ  cÃ³ thá»ƒ Ä‘áº£o ngÆ°á»£c. / Alembic ensures safe, reversible state synchronization between source code (SQLAlchemy Models) and the live database.

Tiáº¿ng Viá»‡t | [English](#-english-version)

---

## ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t

### ğŸ¯ Nhiá»‡m vá»¥ cá»‘t lÃµi (Core Responsibilities)
1. **Theo váº¿t PhiÃªn báº£n Schema**: LÆ°u giá»¯ dÃ²ng thá»i gian cÃ¡c thay Ä‘á»•i cáº¥u trÃºc tÆ°Æ¡ng tá»± nhÆ° Git.
2. **Audit Log Dá»¯ liá»‡u**: Ghi láº¡i lá»‹ch sá»­ ai Ä‘Ã£ Ä‘á»•i gÃ¬, khi nÃ o, phá»¥c vá»¥ truy váº¿t.
3. **Tá»± Ä‘á»™ng hÃ³a Tiáº¿n hÃ³a**: Tá»± Ä‘á»™ng phÃ¡t hiá»‡n thay Ä‘á»•i trong Models Ä‘á»ƒ sinh mÃ£ migration.
4. **Chuáº©n hÃ³a File Migration**: Äáº£m báº£o má»i báº£n ghi migration cÃ³ cáº¥u trÃºc Ä‘á»“ng nháº¥t qua file `.mako`.
5. **Äá»“ng bá»™ Tráº¡ng thÃ¡i**: Äáº£m báº£o mÃ£ nguá»“n Python vÃ  cáº¥u trÃºc DB thá»±c táº¿ luÃ´n khá»›p nhau 100%.

### ï¿½ Cáº¥u trÃºc ThÆ° má»¥c (Directory Layout)
```text
alembic/
â”œâ”€â”€ env.py              # Script Ä‘iá»u khiá»ƒn káº¿t ná»‘i vÃ  náº¡p náº¡p metadata.
â”œâ”€â”€ script.py.mako     # Báº£n thiáº¿t káº¿ (template) cho cÃ¡c file migration.
â””â”€â”€ versions/           # ThÆ° má»¥c chá»©a nháº­t kÃ½ thay Ä‘á»•i cáº¥u trÃºc DB.
```

### ï¿½ğŸ’¡ Bá»‘i cáº£nh & TÆ° duy (Context & Why)
- **Context**: Khi lÃ m viá»‡c nhÃ³m, viá»‡c phá»‘i há»£p thay Ä‘á»•i database lÃ  cá»±c ká»³ rá»§i ro náº¿u khÃ´ng cÃ³ cÃ´ng cá»¥ quáº£n lÃ½ phiÃªn báº£n.
- **Why Alembic?**: LÃ  tiÃªu chuáº©n vÃ ng cho Python/SQLAlchemy, há»— trá»£ tuyá»‡t vá»i cho mÃ´i trÆ°á»ng báº¥t Ä‘á»“ng bá»™ (Async).

### âš ï¸ Quy trÃ¬nh & RÃ ng buá»™c (CCE Template)
- **SQL-Only**: Chá»‰ há»— trá»£ cÃ¡c DB quan há»‡. KhÃ´ng dÃ¹ng cho NoSQL (Redis/Mongo).
- **Review báº¯t buá»™c**: LuÃ´n pháº£i Ä‘á»c file migration Ä‘Æ°á»£c sinh ra trÆ°á»›c khi cháº¡y lá»‡nh upgrade.
- **Immutability**: Cáº¥m tuyá»‡t Ä‘á»‘i viá»‡c sá»­a Ä‘á»•i file migration Ä‘Ã£ Ä‘áº©y lÃªn mÃ¡y chá»§ tháº­t.

### ğŸ›ï¸ VÃ­ dá»¥ thá»±c táº¿ (Examples)
- **Váº­n hÃ nh**: `uv run alembic upgrade head` Ä‘á»ƒ cáº­p nháº­t database.

---

## ğŸ‡ºğŸ‡¸ English Version

### ğŸ¯ Core Responsibilities
1. **Schema Version Tracking**: Maintains a timeline of structural changes, similar to Git for code.
2. **Database Audit Log**: Records change history (who/what/when) for debugging.
3. **Evolution Automation**: Automatically detects model changes to trigger migration generation.
4. **Migration Templating**: Guarantees consistent script format via `.mako` templates.
5. **State Synchronization**: Ensures Python source and live DB schemas are 100% aligned.

### ğŸ“‚ Directory Layout
```text
alembic/
â”œâ”€â”€ env.py              # Core script governing connections and metadata loading.
â”œâ”€â”€ script.py.mako     # Blueprint template for new migration files.
â””â”€â”€ versions/           # Directory storing the cumulative schema history.
```

### ğŸ’¡ Context & Why
- **Context**: In team settings, uncoordinated database changes cause destructive application failures.
- **Why Alembic?**: The de facto standard for SQLAlchemy, offering premier support for Async flows and automated diffing.

### âš ï¸ Process & Constraints (CCE Template)
- **SQL-Only**: Exclusively for RDBMS. Not compatible with NoSQL (Redis/Mongo).
- **Mandatory Audit**: Always inspect autogenerated scripts prior to applying updates.
- **Immutability**: Once a script is deployed, its content must never be modified.

### ğŸ›ï¸ Practical Examples
- **Ops**: `uv run alembic upgrade head` to apply pending changes.
